import { useEffect, useState } from "react";
import TableCard from "../../components/TableCard/TableCard";
import { Vulnerability } from "../../interfaces/interfaces";
import { fetchVulnerabilitiesList } from "../../utils/api";
import InsertModal from "./components/InsertModal/InsertModal";
import "./VulnerabilityTable.css";

function VulnerabilityTable() {
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [dataCount, setDataCount] = useState<number>(0);
  const [currentPage, setCurrentPage] = useState<number>(1);
  const [isInsertModalVisible, setIsInsertModalVisible] =
    useState<boolean>(false);

  const columns = [
    { name: "Id", key: "id" },
    { name: "Nome do HOST", key: "asset_hostname" },
    { name: "Endereço IP", key: "asset_ip_address" },
    { name: "Título da Vulnerabilidade", key: "title" },
    { name: "Severidade", key: "severity" },
    { name: "CVSS", key: "cvss" },
    { name: "Data de Publicação", key: "publication_date" },
    { name: "Corrigida", key: "fixed", type: "bool" },
  ];

  useEffect(() => {
    (async () => {
      await getVulnerabilitiesData(currentPage);
    })();
  }, [currentPage]);

  const getVulnerabilitiesData = async (page: number) => {
    let response = await fetchVulnerabilitiesList(page);

    setVulnerabilities(response.results);
    setDataCount(response.count);
  };

  return (
    <>
      <TableCard
        columns={columns}
        data={vulnerabilities}
        totalDataCount={dataCount}
        currentPage={currentPage}
        setPage={setCurrentPage}
        insertAction={() => setIsInsertModalVisible(true)}
        hasInsertBtn
        refreshCallback={() => getVulnerabilitiesData(currentPage)}
      />
      <InsertModal
        visible={isInsertModalVisible}
        setIsVisible={setIsInsertModalVisible}
      />
    </>
  );
}

export default VulnerabilityTable;
